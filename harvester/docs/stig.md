# STIG Hardening

Combination of STIGs already approved by DISA for:
- SL Micro
- RKE2
- Rancher

SL Micro STIG is approved for 5 but still in draft status for 6.

## Hardening Process

SL Micro is an immutable operating system customized by the Elemental Toolkit.

The host is configured on boot by `systemd` units that call `elemental run-stage <STAGE>` to perform OS configuration during well-defined stages of the boot process. Harvester Government inserts extra hooks into the `initramfs` and `network` stages to implement controls not already inherently met by the default toolchain.

```console
rancher@hvst-0:~> sudo yq /system/oem/89_stig.yaml
name: Harvester STIG Configuration
stages:
  initramfs:
    - commands:
        - dracut -f --regenerate-all
        - groupadd etcd
        - useradd -r -c "etcd user" -g etcd -s /sbin/nologin -M etcd
        - sysctl -p /etc/sysctl.d/99-stig.conf
        - if grep -q '#SHA_CRYPT_MIN_ROUNDS' /etc/login.defs; then sed -i'' -e 's/#SHA_CRYPT_MIN_ROUNDS/SHA_CRYPT_MIN_ROUNDS/g' /etc/login.defs; elif ! grep -q 'SHA_CRYPT_MIN_ROUNDS' /etc/login.defs; then echo "SHA_CRYPT_MIN_ROUNDS 5000" >> /etc/login.defs; fi
        # Modified 25 March 2025  - WMS
        # HAOS-01-000041
        - sed -i '/^PASS_MIN_DAYS/d' /etc/login.defs
        - echo "PASS_MIN_DAYS 1" >> /etc/login.defs
        # HAOS-01-000042
        - sed -i '/^PASS_MAX_DAYS/d' /etc/login.defs
        - echo "PASS_MAX_DAYS 60" >> /etc/login.defs
        # HAOS-01-000186
        - sed -i '/^FAIL_DELAY/d' /etc/login.defs
        - echo "FAIL_DELAY 4" >> /etc/login.defs
        # HAOS-01-000188
        - sed -i '/^UMASK/d' /etc/login.defs
        - echo "UMASK 077" >> /etc/login.defs
        # HAOS-01-000133
        # HAOS-01-000134
        # HAOS-01-000135
        # HAOS-01-000136
        - sed -i'' -e 's/nullok//g' /etc/pam.d/*
        - if ! grep -q '^gpgcheck = on' /etc/zypp/zypp.conf; then echo 'gpgcheck = on' >> /etc/zypp/zypp.conf; fi
        - if ! systemctl status ctrl-alt-del.target | grep -q 'masked'; then systemctl mask ctrl-alt-del.target; systemctl daemon-reload; fi
        - ln -s /dev/null /etc/udev/rules.d/90-issue-generator.rules
        # Ensure sysctl commands get executed
        - sysctl -w vm.panic_on_oom=0
        - sysctl -w vm.overcommit_memory=1
        - sysctl -w kernel.panic=10
        - sysctl -w kernel.panic_on_oops=1
        - sysctl -w kernel.kptr_restrict=1
        - sysctl -w kernel.randomize_va_space=2
        - sysctl -w kernel.dmesg_restrict=1
      files:
        - path: /var/lib/rancher/rke2/server/manifests/rke2-default-serviceaccount.yaml
          permissions: 0600
          owner: 0
          group: 0
          content: |
            # Enable serviceAccountToken mount for Harvester functionality
            apiVersion: v1
            automountServiceAccountToken: true
            kind: ServiceAccount
            metadata:
              name: default
              namespace: default
        - path: /etc/pam.d/common-account
          permissions: 0600
          owner: 0
          group: 0
          content: |
            #%PAM-1.0
            #
            # This file is autogenerated by pam-config. All manual
            # changes will be overwritten!
            #
            # The pam-config configuration files can be used as template
            # for an own PAM configuration not managed by pam-config:
            #
            # for i in account auth password session; do \
            #      rm -f common-$i; sed '/^#.*/d' common-$i-pc > common-$i; \
            # done
            #
            # Afterwards common-{account, auth, password, session} can be
            # adjusted. Never edit or delete common-*-pc files!
            #
            # WARNING: changes done by pam-config afterwards are not
            # visible to the PAM stack anymore!
            #
            # WARNING: self managed PAM configuration files are not supported,
            # will not see required adjustments by pam-config and can become
            # insecure or break system functionality through system updates!
            #
            #
            # Account-related modules common to all services
            #
            # This file is included from other service-specific PAM config files,
            # and should contain a list of the account modules that define
            # the central access policy for use on the system.
            #
            # Modified 25 March 2025  - WMS
            # HAOS-01-000004
            account	required	pam_faillock.so
            account	required	pam_unix.so	try_first_pass
        - path: /etc/pam.d/common-auth
          permissions: 0600
          owner: 0
          group: 0
          content: "#%PAM-1.0\n#\n# This file is autogenerated by pam-config. All manual\n# changes will be overwritten!\n#\n# The pam-config configuration files can be used as template\n# for an own PAM configuration not managed by pam-config:\n#\n# for i in account auth password session; do \\\n#      rm -f common-$i; sed '/^#.*/d' common-$i-pc > common-$i; \\\n# done\n#\n# Afterwards common-{account, auth, password, session} can be\n# adjusted. Never edit or delete common-*-pc files!\n#\n# WARNING: changes done by pam-config afterwards are not\n# visible to the PAM stack anymore!\n#\n# WARNING: self managed PAM configuration files are not supported,\n# will not see required adjustments by pam-config and can become\n# insecure or break system functionality through system updates!\n#\n#\n# Authentication-related modules common to all services\n#\n# This file is included from other service-specific PAM config files,\n# and should contain a list of the authentication modules that define\n# the central authentication scheme for use on the system\n# (e.g., /etc/shadow, LDAP, Kerberos, etc.). The default is to use the\n# traditional Unix authentication mechanisms.\n#\n# Modified 25 March 2025  - WMS\n# HAOS-01-000004\nauth    required        pam_faillock.so onerr=fail silent audit deny=3\nauth\trequired\tpam_env.so\t\nauth\trequired\tpam_unix.so\ttry_first_pass \n"
        - path: /etc/pam.d/common-password
          permissions: 0600
          owner: 0
          group: 0
          content: "#%PAM-1.0\n#\n# This file is autogenerated by pam-config. All manual\n# changes will be overwritten!\n#\n# The pam-config configuration files can be used as template\n# for an own PAM configuration not managed by pam-config:\n#\n# for i in account auth password session; do \\\n#      rm -f common-$i; sed '/^#.*/d' common-$i-pc > common-$i; \\\n# done\n#\n# Afterwards common-{account, auth, password, session} can be\n# adjusted. Never edit or delete common-*-pc files!\n#\n# WARNING: changes done by pam-config afterwards are not\n# visible to the PAM stack anymore!\n#\n# WARNING: self managed PAM configuration files are not supported,\n# will not see required adjustments by pam-config and can become\n# insecure or break system functionality through system updates!\n#\n#\n# Password-related modules common to all services\n#\n# This file is included from other service-specific PAM config files,\n# and should contain a list of modules that define  the services to be\n# used to change user passwords.\n#\n# Modified 25 March 2025  - WMS\n# HAOS-01-000035 \n# HAOS-01-000036\n# HAOS-01-000037\n# HAOS-01-000038\n# HAOS-01-000086\n# HAOS-01-000044\npassword    requisite    pam_pwquality.so ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 difok=8 minlen=15 \npassword    requisite    pam_pwhistory.so remember=5 use_authtok\npassword\trequired\tpam_unix.so\tuse_authtok  shadow try_first_pass\n"
        - path: /etc/audit/auditd.conf
          permissions: 0600
          owner: 0
          group: 0
          content: |
            #
            # This file controls the configuration of the audit daemon
            #

            local_events = yes
            write_logs = yes
            log_file = /var/log/audit/audit.log
            log_group = audit
            log_format = RAW
            flush = INCREMENTAL_ASYNC
            freq = 50
            max_log_file = 8
            num_logs = 5
            priority_boost = 4
            name_format = NONE
            ##name = mydomain
            max_log_file_action = ROTATE
            space_left = 75
            space_left_action = SYSLOG
            verify_email = yes
            action_mail_acct = root
            admin_space_left = 50
            admin_space_left_action = SUSPEND
            disk_full_action = SUSPEND
            disk_error_action = SUSPEND
            use_libwrap = yes
            ##tcp_listen_port = 60
            tcp_listen_queue = 5
            tcp_max_per_addr = 1
            ##tcp_client_ports = 1024-65535
            tcp_client_max_idle = 0
            transport = TCP
            distribute_network = no
            q_depth = 1200
            overflow_action = SYSLOG
            max_restarts = 10
            plugin_dir = /etc/audit/plugins.d
            end_of_event_timeout = 2
        - path: /etc/permissions.local
          permissions: 0600
          owner: 0
          group: 0
          content: |
            /var/log/audit root:root 600
            /var/log/audit/audit.log root:root 600
            /etc/audit/audit.rules root:root 600
            /etc/audit/rules.d/audit.rules root:root 600
            /usr/sbin/audispd root:root 0750
            /usr/sbin/auditctl root:root 0750
            /usr/sbin/auditd root:root 0750
            /usr/sbin/ausearch root:root 0755
            /usr/sbin/aureport root:root 0755
            /usr/sbin/autrace root:root 0750
            /usr/sbin/augenrules root:root 0750
        - path: /etc/security/limits.conf
          permissions: 0600
          owner: 0
          group: 0
          content: "# /etc/security/limits.conf\n#\n#Each line describes a limit for a user in the form:\n#\n#<domain>        <type>  <item>  <value>\n#\n#Where:\n#<domain> can be:\n#        - a user name\n#        - a group name, with @group syntax\n#        - the wildcard *, for default entry\n#        - the wildcard %, can be also used with %group syntax,\n#                 for maxlogin limit\n#\n#<type> can have the two values:\n#        - \"soft\" for enforcing the soft limits\n#        - \"hard\" for enforcing hard limits\n#\n#<item> can be one of the following:\n#        - core - limits the core file size (KB)\n#        - data - max data size (KB)\n#        - fsize - maximum filesize (KB)\n#        - memlock - max locked-in-memory address space (KB)\n#        - nofile - max number of open file descriptors\n#        - rss - max resident set size (KB)\n#        - stack - max stack size (KB)\n#        - cpu - max CPU time (MIN)\n#        - nproc - max number of processes\n#        - as - address space limit (KB)\n#        - maxlogins - max number of logins for this user\n#        - maxsyslogins - max number of logins on the system\n#        - priority - the priority to run user process with\n#        - locks - max number of file locks the user can hold\n#        - sigpending - max number of pending signals\n#        - msgqueue - max memory used by POSIX message queues (bytes)\n#        - nice - max nice priority allowed to raise to values: [-20, 19]\n#        - rtprio - max realtime priority\n#\n#<domain>      <type>  <item>         <value>\n#\n\n#*               soft    core            0\n#*               hard    rss             10000\n#@student        hard    nproc           20\n#@faculty        soft    nproc           20\n#@faculty        hard    nproc           50\n#ftp             hard    nproc           0\n#@student        -       maxlogins       4\n\n* hard maxlogins 10\n# HAOS-01-000070 // SRG-OS-000184-GPOS-00078 \n* soft core 0\n* hard core 0\n\n# End of file\n"
        - path: /etc/sysctl.d/99-stig.conf
          permissions: 0600
          owner: 0
          group: 0
          content: |
            vm.panic_on_oom=0
            vm.overcommit_memory=1
            kernel.panic=10
            kernel.panic_on_oops=1
            kernel.kptr_restrict=1
            kernel.randomize_va_space=2
            kernel.dmesg_restrict=1
        - path: /etc/profile.d/autologout.sh
          permissions: 0755
          owner: 0
          group: 0
          content: |
            TMOUT=900
            readonly TMOUT
            export TMOUT
        - path: /etc/ssh/sshd_config.d/stig.conf
          permissions: 0600
          owner: 0
          group: 0
          content: |
            KexAlgorithms ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256
            MACs hmac-sha2-512,hmac-sha2-256
            Ciphers aes256-ctr,aes192-ctr,aes128-ctr
            PermitEmptyPasswords no
            PermitUserEnvironment no
            Banner /etc/issue
            ClientAliveInterval 600
            ClientAliveCountMax 1
        - path: /etc/issue.d/10-SUSE
          permissions: 0600
          owner: 0
          group: 0
          content: |2

            You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only. By using this IS (which includes any device attached to this IS), you consent to the following conditions:

            - The USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM), law enforcement (LE), and counterintelligence (CI) investigations.
            - At any time, the USG may inspect and seize data stored on this IS.
            - Communications using, or data stored on, this IS are not private, are subject to routine monitoring, interception, and search, and may be disclosed or used for any USG authorized purpose.
            - This IS includes security measures (e.g., authentication and access controls) to protect USG interests--not for your personal benefit or privacy.
            - Notwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, related to personal representation or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work product are private and confidential. See User Agreement for details.
        - path: /etc/audit/rules.d/audit.rules
          permissions: 0600
          owner: 0
          group: 0
          content: "## This set of rules is to suppress the performance effects of the\n## audit system. The result is that you only get hardwired events.\n-D\n\n## Required for STIG compliance\n-w /var/log/btmp -p wa -k login_mod\n-w /var/log/wtmp -p wa -k login_mod\n-w /run/utmp -p wa -k login_mod\n-w /etc/sudoers -p wa -k privileged-actions\n-w /etc/sudoers.d -p wa -k privileged-actions\n-w /var/log/tallylog -p wa -k logins\n-w /var/log/lastlog -p wa -k logins\n-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid\n-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid\n-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid\n-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid\n-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b32 -S umount -F auid>=1000 -F auid!=unset -k privileged-umount\n-a always,exit -F arch=b32 -S umount2 -F auid>=1000 -F auid!=unset -k privileged-umount\n-a always,exit -F arch=b64 -S umount2 -F auid>=1000 -F auid!=unset -k privileged-umount\n-a always,exit -F arch=b32 -S setxattr,fsetxattr,lsetxattr,removexattr,fremovexattr,lremovexattr -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b64 -S setxattr,fsetxattr,lsetxattr,removexattr,fremovexattr,lremovexattr -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=unset -k privileged-mount\n-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=unset -k privileged-mount\n-a always,exit -F arch=b32 -S init_module,finit_module -F auid>=1000 -F auid!=unset -k moduleload\n-a always,exit -F arch=b64 -S init_module,finit_module -F auid>=1000 -F auid!=unset -k moduleload\n-a always,exit -F arch=b32 -S delete_module -F auid>=1000 -F auid!=unset -k unload_module\n-a always,exit -F arch=b64 -S delete_module -F auid>=1000 -F auid!=unset -k unload_module\n-a always,exit -F arch=b32 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -k perm_access\n-a always,exit -F arch=b64 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -k perm_access\n-a always,exit -F arch=b32 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -k perm_access\n-a always,exit -F arch=b64 -S creat,open,openat,open_by_handle_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -k perm_access\n-a always,exit -F arch=b32 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod\n-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod\n-w /etc/shadow -p wa -k account_mod\n-w /etc/passwd -p wa -k account_mod\n-w /etc/security/opasswd -p wa -k account_mod\n-w /etc/group -p wa -k account_mod\n-a always,exit -F path=/usr/sbin/usermod -F perm=x -F auid>=1000 -F auid!=unset -k privileged-usermod\n-a always,exit -F path=/sbin/unix_chkpwd -F perm=x -F auid>=1000 -F auid!=unset -k privileged-unix-chkpwd\n-a always,exit -F path=/sbin/unix2_chkpwd -F perm=x -F auid>=1000 -F auid!=unset -k privileged-unix2-chkpwd\n-a always,exit -F path=/usr/bin/sudoedit -F perm=x -F auid>=1000 -F auid!=unset -k privileged-sudoedit\n-a always,exit -F path=/usr/bin/sudo -F perm=x -F auid>=1000 -F auid!=unset -k privileged-sudo\n-a always,exit -F path=/usr/bin/su -F perm=x -F auid>=1000 -F auid!=unset -k privileged-priv_change\n-a always,exit -F path=/usr/lib/ssh/ssh-keysign -F perm=x -F auid>=1000 -F auid!=unset -k privileged-ssh-keysign\n-a always,exit -F path=/usr/bin/ssh-agent -F perm=x -F auid>=1000 -F auid!=unset -k privileged-ssh-agent\n-w /sbin/rmmod -p x -k modules\n-a always,exit -F path=/usr/bin/rm -F perm=x -F auid>=1000 -F auid!=unset -k prim_mod\n-a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=1000 -F auid!=unset -k privileged-passwd\n-a always,exit -F path=/sbin/pam_timestamp_check -F perm=x -F auid>=1000 -F auid!=unset -k privileged-pam_timestamp_check\n-a always,exit -F path=/usr/bin/newgrp -F perm=x -F auid>=1000 -F auid!=unset -k privileged-newgrp\n-w /sbin/modprobe -p x -k modules \n-w /usr/bin/kmod -p x -k modules\n-w /sbin/insmod -p x -k modules \n-a always,exit -F path=/usr/bin/gpasswd -F perm=x -F auid>=1000 -F auid!=unset -k privileged-gpasswd\n-a always,exit -F path=/usr/bin/crontab -F perm=x -F auid>=1000 -F auid!=unset -k privileged-crontab\n-a always,exit -F path=/usr/bin/chsh -F perm=x -F auid>=1000 -F auid!=unset -k privileged-chsh\n-a always,exit -F path=/usr/bin/chmod -F perm=x -F auid>=1000 -F auid!=unset -k prim_mod\n-a always,exit -F path=/usr/bin/chfn -F perm=x -F auid>=1000 -F auid!=unset -k privileged-chfn\n-a always,exit -F path=/usr/bin/chcon -F perm=x -F auid>=1000 -F auid!=unset -k prim_mod\n-a always,exit -F path=/usr/bin/chage -F perm=x -F auid>=1000 -F auid!=unset -k privileged-chage\n-a always,exit -F path=/usr/bin/chacl -F perm=x -F auid>=1000 -F auid!=unset -k prim_mod\n"
        - path: /var/lib/rancher/rke2/server/manifests/rke2-multus-config.yaml
          permissions: 0600
          owner: 0
          group: 0
          content: |
            # Enable proper cert rotation when cis profile is enabled for rke2 v1.34.2+
            apiVersion: helm.cattle.io/v1
            kind: HelmChartConfig
            metadata:
              name: rke2-multus
              namespace: kube-system
            spec:
              valuesContent: |-
                config:
                  cni_conf:
                    cleanupConfigOnExit: true
  network:
    - commands:
        # Set audit permissions
        - chmod 600 /var/log/audit
        - chown root:root /var/log/audit
        - chmod 600 /var/log/audit/audit.log
        - chown root:root /var/log/audit/audit.log
        - chmod 600 /etc/audit/audit.rules
        - chown root:root /etc/audit/audit.rules
        - chmod 600 /etc/audit/rules.d/audit.rules
        - chown root:root /etc/audit/rules.d/audit.rules
        # HAOS-01-000136
        - sed -i 's/NOPASSWD/PASSWD/g' /etc/sudoers
```
